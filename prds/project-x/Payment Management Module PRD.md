# 项目经费管理 - 收款管理模块 PRD 需求文档 (更新版)

### **1. 模块概述 (Module Overview)**

*   **1.1 模块名称：** 项目经费管理 - 收款管理
*   **1.2 模块目标：**
    *   实现项目款项的准确、及时回笼，确保资金流的透明与可追溯。
    *   提供清晰的收款记录列表、详情和操作界面，支持财务人员日常收款管理工作。
    *   有效识别并处理收款过程中可能出现的异常情况。
    *   为项目结算的最终财务闭环提供数据支撑。
*   **1.3 业务价值：**
    *   提升资金回笼效率，降低人工核对和处理的错误率。
    *   保障财务数据的准确性、完整性和合规性（符合FDA 21 CFR Part 11及审计要求）。
    *   优化财务工作流程，减少坏账风险。
    *   为项目成本核算、绩效评估提供完整的资金回笼数据。
*   **1.4 适用角色：** 财务人员（核心操作者）、项目经理（查看项目收款状态）。

### **2. 核心数据概念与关系 (Core Data Concepts & Relationships)**

*   **2.1 主要实体：**
    *   **收款记录 (Receipt)：** 核心实体，每笔实际收到的款项。
    *   **发票 (Invoice)：** 收款核销的直接对象。
    *   **结算单 (Settlement)：** 发票的依据，收款的间接依据。
    *   **项目 (Project)：** 收款的最终归属。

*   **2.2 实体关系：**
    *   `收款记录 (N) : (1) 发票`：一张发票可以被多笔收款记录（如分期付款）部分核销或全额核销。
    *   `发票 (N) : (1) 结算单`：一张结算单可以对应多张发票。
    *   `结算单 (N) : (1) 项目`：一个项目可以有多张结算单。

*   **2.3 关键字段列表 (Receipt Entity Fields)：**

| 数据字段       | 数据类型   | 说明                                                         | 示例数据                                     |
| :------------- | :--------- | :----------------------------------------------------------- | :------------------------------------------- |
| **收款ID**     | 字符串     | **唯一标识符**。系统自动生成。                               | `RECEIPT-20250720-001`                       |
| **收款流水号**   | 字符串     | 银行/第三方支付平台提供的交易流水号。                      | `BANKTXN123456789`                           |
| **收款日期**   | 日期时间   | **必填**。款项实际到账的日期时间。                         | `2025-07-20 09:15:00`                        |
| **收款金额**   | 数值       | **必填**。实际到账的金额。                                   | `10,000.00`                                  |
| **收款银行账户** | 关联ID/字符串 | 平台方接收款项的银行账户名称/ID。                        | `招商银行-主收款户`                          |
| **付款方名称**   | 字符串     | **必填**。实际打款的企业或个人名称。                       | `XX生物科技股份有限公司`                     |
| **付款方账户**   | 字符串     | （可选）付款方的银行账号或支付账号。                       | `6222XXXXXXXXXX`                             |
| **关联发票ID**   | 关联ID     | **必填**。该笔收款关联的**主发票ID**。                      | `INV-20250719-001`                           |
| **本次核销金额** | 数值       | **只读**。本次收款实际用于核销关联发票的金额。             | `10,000.00` / `8,000.00`                     |
| **收款状态**   | 枚举       | **只读**。`待确认`, `已确认`, `部分确认`, `异常`, `已退回`  | `待确认`                                     |
| **异常原因**   | 文本       | 如果收款状态为`异常`，记录原因。                           | `无匹配发票`, `金额不符`, `付款方信息不明`   |
| **备注**       | 文本       | 对该笔收款的额外说明。                                       | `对应发票INV-0012345678的第一次付款`         |
| **收款凭证附件** | 文件ID/URL | **可选**。银行回单、转账截图等证明文件。                   | `receipt_001.pdf`                            |
| **确认人**     | 关联ID     | 完成收款确认操作的人员。                                   | `U003 (财务王)`                              |
| **确认时间**   | 日期时间   | 完成收款确认操作的时间。                                   | `2025-07-20 09:30:00`                        |
| **创建人/时间** | 系统自动   | 记录收款记录的创建者和创建时间。                           |                                              |
| **最后修改人/时间** | 系统自动 | 记录收款记录的最后修改者和最后修改时间。                   |                                              |

### **3. 模块功能范围 (Module Functional Scope)**

*   **3.1 页面清单 (List of Pages)：**

    本模块包含以下主要页面：

    ```mermaid
    graph TD
        subgraph 收款管理模块
            A[收款记录列表] --> B(登记收款)
            A --> C(收款记录详情)
            A --> D(冲销收款记录)
            C --> D
        end
    ```

    *   **3.1.1 收款记录列表页 (Receipt Record List Page)：**
        *   **目的：** 提供所有收款记录的概览，支持多维度筛选和搜索。
        *   **内容：** 展示收款ID、收款流水号、收款日期、收款金额、付款方名称、关联发票号、收款银行账户、收款状态、确认人、确认时间等关键概览字段。
        *   **操作：**
            *   `[ 登记收款 ]`：入口，用于手动录入新的收款记录。
            *   点击任一记录进入"收款记录详情页"。
            *   根据收款状态和权限，动态显示操作按钮：`[ 确认收款 ]` (针对`待确认`、`部分确认`、`异常`状态)、`[ 冲销收款 ]` (针对`已确认`状态)、`[ 处理异常 ]` (针对`异常`状态)、`[ 查看 ]` (通用)。
    *   **3.1.2 登记收款记录页 (Register Receipt Record Page)：**
        *   **目的：** 用户手动录入收到的款项信息。
        *   **内容：** 表单形式，包含上述“收款”实体的所有可编辑字段。
        *   **功能：**
            *   用户填写收款日期、金额、付款方信息、收款银行账户、银行流水号等。
            *   **发票匹配功能：** 用户可搜索并选择一张或多张待收款的发票进行关联（系统应显示发票的未收款金额）。
            *   系统自动计算本次收款实际核销关联发票的金额。
            *   支持上传`收款凭证附件`（如银行回单、转账截图）。
        *   **操作：** `[ 提交 ]`、`[ 取消 ]`。
    *   **3.1.3 收款记录详情页 (Receipt Record Detail Page)：**
        *   **目的：** 展示单笔收款记录的所有详细信息，包括其关联的发票和处理历史。
        *   **内容：** 完整显示上述“收款”实体的所有字段。可包含子表格或链接，展示该收款记录关联的发票及核销情况。
        *   **操作：** 可链接到关联的`发票详情`、`结算单详情`、`项目详情`。根据收款状态，可能提供`[ 处理异常 ]`、`[ 退款 ]`等按钮。
    *   **3.1.4 处理收款异常页 (Process Receipt Exception Page)：**
        *   **目的：** 专门用于处理`异常`状态的收款记录，进行人工核对与调整。
        *   **内容：** 显示异常收款记录的全部详情（只读）。提供处理方案选择（如手动匹配发票、核销差额、发起退款、标记为无法处理/忽略）。用户需填写`处理意见/结果`。
        *   **操作：** `[ 提交处理结果 ]`、`[ 取消 ]`。
    *   **3.1.5 冲销收款记录页 (Reverse Receipt Record Page)：**
        *   **目的：** 对已确认的收款记录进行冲销操作，撤销其对发票和项目收款状态的影响。
        *   **内容：** 显示待冲销收款记录的全部详情（只读）。展示冲销后对关联发票收款状态的影响预览。用户需填写`冲销原因`和`冲销说明`。
        *   **操作：** `[ 确认冲销 ]`、`[ 取消 ]`。

*   **3.2 核心功能流程 (Core Functional Flows)：**

    收款管理的核心流程，围绕收款的登记、匹配与确认，并处理异常情况。

    ```mermaid
    flowchart TD
        P[接收银行到账通知<br/>(外部系统)] --> Q[登记收款信息<br/>(人工/自动)]
        Q --> R[匹配关联发票]
        R --> S{匹配成功 & 金额一致?}

        S -- 是 --> T[更新发票收款状态]
        S -- 是 --> U[更新项目收款状态]
        S -- 是 --> V[完成收款确认]
        V --> W[流程结束]
        V --> V1[收款记录冲销<br/>(按需)]
        V1 --> V2[逆向更新发票收款状态]
        V1 --> V3[逆向更新项目收款状态]
        V1 --> V4[标记收款记录为已冲销]
        V4 --> W

        S -- 否 --> X[标记收款异常]
        X --> Y[通知财务人员处理]
        Y --> Z(处理收款异常)
        Z --> Z1{处理方案?}
        Z1 -->|手动匹配发票| R
        Z1 -->|核销差额| T
        Z1 -->|发起退款| Z2[执行退款流程<br/>(外部系统)] --> W
        Z1 -->|标记无法处理| W
    ```

    *   **3.2.1 登记收款流程：**
        1.  **触发：** 财务收到银行到账通知，需手动在系统内登记。
        2.  **操作：** 财务人员进入“收款记录列表页”，点击`[ 登记收款 ]`，进入“登记收款记录页”。
        3.  **信息填写：** 填写收款日期、金额、付款方等基本信息。
        4.  **发票匹配：** 搜索并选择关联发票进行核销，系统计算并显示本次核销金额。
        5.  **凭证上传：** 上传收款凭证附件。
        6.  **提交：** 点击`[ 提交 ]`。
        7.  **系统响应：**
            *   创建新的收款记录。
            *   根据匹配结果和金额是否一致，自动将收款记录状态置为`已确认`、`部分确认`或`异常`。
            *   更新关联发票的`已收款金额`和`发票状态`（如`已开具` -> `部分收款` -> `已收款`）。
            *   记录操作人、时间及所有变更，创建审计日志。

    *   **3.2.2 收款异常处理流程：**
        1.  **触发：**
            *   系统在登记收款时自动判断为`异常`状态。
            *   财务人员在"收款记录列表页"筛选`异常`状态并主动发起处理。
        2.  **操作：** 财务人员点击`[ 处理异常 ]`（在列表页或详情页）。
        3.  **异常分析：** 进入"处理收款异常页"，查看异常原因和收款详情。
        4.  **选择处理方案：** 根据具体异常类型（无匹配发票、金额不符等），选择合适的处理方案（如手动匹配、核销差额、发起退款等）。
        5.  **填写处理意见：** 详细说明处理过程和结果。
        6.  **提交：** 点击`[ 提交处理结果 ]`。
        7.  **系统响应：**
            *   更新收款记录状态（如`异常` -> `已确认`/`已退回`/`已忽略`等）。
            *   更新关联发票的收款状态（如适用）。
            *   记录详细的处理日志，符合审计要求。
            *   （可选）触发审批流程（如大额差额核销、退款等）。

    *   **3.2.3 收款记录冲销流程：**
        1.  **触发：**
            *   财务人员发现已确认的收款记录存在错误（如重复收款、收款信息错误等）。
            *   客户要求退款或收款需要撤销。
            *   财务人员在"收款记录列表页"或"收款记录详情页"主动发起冲销。
        2.  **操作：** 财务人员点击`[ 冲销收款 ]`（仅对`已确认`状态的收款记录可用）。
        3.  **冲销确认：** 进入"冲销收款记录页"，查看待冲销收款记录的详情和冲销影响预览。
        4.  **填写冲销信息：** 选择冲销原因（客户要求退款、收款信息错误、重复收款等），填写详细的冲销说明。
        5.  **影响预览：** 系统显示冲销后对关联发票收款状态、项目收款状态的影响。
        6.  **提交：** 点击`[ 确认冲销 ]`。
        7.  **系统响应：**
            *   将收款记录状态更新为`已冲销`。
            *   逆向更新关联发票的`已收款金额`和`发票状态`（如`已收款` -> `部分收款` -> `已开具`）。
            *   逆向更新项目的收款统计数据。
            *   记录冲销操作人、时间、原因及所有变更，创建完整的审计日志。
            *   （可选）触发退款审批流程或通知相关人员处理后续退款事宜。

### **4. 非功能性需求 (Non-Functional Requirements)**

*   **4.1 性能：** 收款记录的录入、查询、发票匹配操作应响应迅速，确保财务操作效率。
*   **4.2 安全与合规性：**
    *   **数据完整性 (FDA 21 CFR Part 11)：** 所有收款记录及其状态变更、核销操作、异常处理流程，必须完整、准确、不可篡改地记录，并支持审计追踪。
    *   **审计追踪：** 详细记录每次收款登记、确认、异常处理的操作人、操作时间、变更内容及理由。
    *   **权限控制：** 收款登记、确认、异常处理、退款等操作需严格的基于角色的权限控制，确保操作合规。
    *   **凭证管理：** 收款凭证附件（银行回单等）需安全存储，并支持随时查看和导出。
*   **4.3 可用性：** 界面应直观、流程清晰，特别是发票匹配和异常处理应提供明确的指引和提示。
*   **4.4 可扩展性：**
    *   预留与银行接口、第三方支付平台（如支付宝/微信支付）对接的扩展点，未来可实现部分自动对账。
    *   预留与外部ERP/财务总账系统对接的能力，实现财务数据的同步。